<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í´ë” ë©”ë‰´ ì‹œìŠ¤í…œ - ë™ì  íŒŒì¼ ë¡œë“œ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            height: 100vh;
            background: #f5f5f5;
        }
        
        .sidebar {
            width: 250px;
            background: #2c3e50;
            color: white;
            overflow-y: auto;
            padding: 20px 0;
            scrollbar-width: thin;
            scrollbar-color: #4a6280 #2c3e50;
        }

        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: #2c3e50;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background-color: #4a6280;
            border-radius: 3px;
        }
        
        .menu-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }
        
        .menu-item:hover {
            background: #34495e;
            border-left-color: #3498db;
        }
        
        .menu-item.active {
            background: #3498db;
            border-left-color: #2980b9;
            font-weight: bold;
        }
        
        .submenu {
            padding-left: 40px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
        }
        
        .submenu.active {
            max-height: 100vh;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #4a6280 #2c3e50;
        }

        .submenu.active::-webkit-scrollbar {
            width: 4px;
        }

        .submenu.active::-webkit-scrollbar-thumb {
            background-color: #4a6280;
            border-radius: 3px;
        }
        
        .submenu-item {
            padding: 10px 0;
            cursor: pointer;
            font-size: 14px;
            opacity: 0.8;
            transition: all 0.2s ease;
        }
        
        .submenu-item:hover {
            opacity: 1;
            padding-left: 10px;
        }
        
        .submenu-item.active {
            color: #f39c12;
            font-weight: bold;
        }
        
        .content {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            background: white;
            display: flex;
            flex-direction: column;
        }
        
        .content.markdown-body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            font-size: 16px;
            line-height: 1.6;
            color: #24292e;
        }
        
        .content-placeholder {
            text-align: center;
            color: #999;
            padding: 60px 20px;
        }

        /* ì´ˆê¸° ë¡œë”© í™”ë©´ì— í‘œì‹œí•  ë¡œê³  */
        .initial-logo {
            max-width: 70%;
            height: auto;
            display: block;
            margin: 0 auto 20px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .toggle-icon {
            float: right;
            font-size: 12px;
        }

        .breadcrumb {
            font-size: 12px;
            color: #999;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        /* íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° ìŠ¤íƒ€ì¼ */
        .file-preview {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            max-width: 600px;
            max-height: 70vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 10000;
            display: none;
        }

        .file-preview.show {
            display: block;
        }

        .file-preview-header {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .file-preview-content {
            font-size: 13px;
            line-height: 1.6;
            color: #333;
            white-space: pre-wrap;
            word-break: break-word;
        }

        /* í†µê³„ íŒ¨ë„ */
        .stats-panel {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 13px;
        }

        .stat-item {
            padding: 8px;
            border-bottom: 1px solid #e9e9e9;
            display: flex;
            justify-content: space-between;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
            }
            
            .content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar" id="sidebar">
        <!-- ë©”ë‰´ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
    </div>
    
    <div class="content markdown-body" id="content">
        <div class="content-placeholder">
            <div style="font-size: 60px; margin-bottom: 20px;">ğŸ¦</div>
            <h1 style="margin-bottom: 10px;">SBJ Bank</h1>
            <p>ğŸ‘ˆ ì¢Œì¸¡ ë©”ë‰´ì—ì„œ í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”</p>
        </div>
    </div>

    <!-- íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° ì˜¤ë²„ë ˆì´ -->
    <div class="file-preview" id="filePreview">
        <div class="file-preview-header" id="previewHeader"></div>
        <div class="file-preview-content" id="previewContent"></div>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script>
        // Google Drive API ì„¤ì •
        const GOOGLE_API_KEY = 'AIzaSyDOIdawmHgkx2wV04ohDl8_jaDNhOjibdg'; // Google Cloudì—ì„œ ë°›ì€ API í‚¤ ì…ë ¥
        const CLIENT_ID = '906251648544-lv0g297k3e0ckde767lvritqkmv6eben.apps.googleusercontent.com'; // OAuth 2.0 í´ë¼ì´ì–¸íŠ¸ ID

        // ë©”ë‰´ êµ¬ì¡° ì •ì˜ (ë¡œì»¬ ë§ˆí¬ë‹¤ìš´ íŒŒì¼)
        // 'ìë£Œì‹¤(êµ¬ê¸€ë“œë¼ì´ë¸Œ)' í•­ëª©ì€ Google Drive í´ë”ì—ì„œ ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤.
        // Google Drive í´ë” ID(í´ë” ê³µìœ  URLì—ì„œ 'folders/â€¦' ë’¤ì— ë‚˜ì˜¤ëŠ” ë¬¸ìì—´)
        // ì˜ˆ: https://drive.google.com/drive/folders/19VQbUHcEtMnTMR39ciOYMrS0RCGTAf7b
        const SERVICE_FOLDER_ID = '19VQbUHcEtMnTMR39ciOYMrS0RCGTAf7b'; // ì—¬ê¸°ì— ì‹¤ì œ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”

        const menuData = {
            "ì†Œê°œ": {
                "íšŒì‚¬ ê°œìš”": "company-overview.md",
                "ë¯¸ì…˜ & ë¹„ì „": "mission-vision.md",
                "íŒ€ ì†Œê°œ": "team-intro.md"
            },
            "ìë£Œì‹¤(êµ¬ê¸€ë“œë¼ì´ë¸Œ)": null, // ë‚˜ì¤‘ì— ë“œë¼ì´ë¸Œì—ì„œ ë¡œë“œ
            "ìë£Œì‹¤(ì˜µì‹œë””ì•ˆ)": null, // ë‚˜ì¤‘ì— ë¡œì»¬ ì„œë²„ì—ì„œ ë¡œë“œ
            "ë¬¸ì„œ": {
                "ì‚¬ìš© ì„¤ëª…ì„œ": "user-manual.md",
                "FAQ": "faq.md",
                "ê¸°ìˆ  ê°€ì´ë“œ": "tech-guide.md",
                "ğŸ“Š ë‹¤ìš´ë¡œë“œ í†µê³„": "STATS"
            }
        };

        const sidebar = document.getElementById('sidebar');
        const content = document.getElementById('content');
        let currentFileId = null;

        // -------- Google Drive API helpers --------
        let driveInitialized = false;
        let driveMenuLoaded = false;
        let obsidianMenuLoaded = false;

        function initGapiClient() {
            return new Promise((resolve, reject) => {
                if (driveInitialized) {
                    resolve();
                    return;
                }
                gapi.load('client', async () => {
                    try {
                        await gapi.client.init({
                            apiKey: GOOGLE_API_KEY,
                            discoveryDocs: [
                                'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'
                            ]
                        });
                        driveInitialized = true;
                        resolve();
                    } catch (err) {
                        reject(err);
                    }
                });
            });
        }

        async function fetchDriveFilesFromFolder(folderId) {
            await initGapiClient();
            const response = await gapi.client.drive.files.list({
                q: `'${folderId}' in parents and trashed=false`,
                pageSize: 100,
                fields: 'files(id,name,mimeType)'
            });
            return response.result.files || [];
        }

        // -------- ë‹¤ìš´ë¡œë“œ í†µê³„ -------- 
        function recordDownload(fileName, fileId) {
            try {
                let stats = JSON.parse(localStorage.getItem('downloadStats')) || [];
                const now = new Date();
                
                // ì´ë¯¸ ë‹¤ìš´ë¡œë“œëœ íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
                const existingItem = stats.find(s => s.fileId === fileId);
                
                if (existingItem) {
                    existingItem.count += 1;
                    existingItem.lastDownload = now.toLocaleString('ko-KR');
                } else {
                    stats.push({
                        fileId: fileId,
                        fileName: fileName,
                        count: 1,
                        firstDownload: now.toLocaleString('ko-KR'),
                        lastDownload: now.toLocaleString('ko-KR')
                    });
                }
                
                localStorage.setItem('downloadStats', JSON.stringify(stats));
                updateStatsDisplay();
            } catch (err) {
                console.error('ë‹¤ìš´ë¡œë“œ í†µê³„ ê¸°ë¡ ì—¤ë¥˜:', err);
            }
        }

        // í†µê³„ í™”ë©´ì— í‘œì‹œ
        function updateStatsDisplay() {
            try {
                const stats = JSON.parse(localStorage.getItem('downloadStats')) || [];
                
                // ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ (ê°€ì¥ ìµœê·¼ ë‹¤ìš´ë¡œë“œ ìˆœ)
                stats.sort((a, b) => new Date(b.lastDownload) - new Date(a.lastDownload));
                
                // ë‹¨ì¼ ìœ¼
                let statsHtml = '<div class="stats-panel">';
                statsHtml += '<strong>ğŸ“„ ë‹¤ìš´ë¡œë“œ ë‚´ì—­</strong><div style="margin-top: 10px;">';
                
                if (stats.length === 0) {
                    statsHtml += '<p style="opacity: 0.6;">ë‹¤ìš´ë¡œë“œ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                } else {
                    stats.forEach((stat, idx) => {
                        statsHtml += `<div class="stat-item">`;
                        statsHtml += `<div><strong>${stat.fileName}</strong><br/>`;
                        statsHtml += `<small>ì´ˆë ¹ ë‹¤ìš´: ${stat.firstDownload}<br/>`;
                        statsHtml += `ë§ˆì§€ë§‰ ë‹¤ìš´: ${stat.lastDownload}</small></div>`;
                        statsHtml += `<div style="text-align: right; font-weight: bold; color: #3498db;">${stat.count}íšŒ</div>`;
                        statsHtml += `</div>`;
                    });
                }
                statsHtml += '</div></div>';
                
                // ì»¨ìš´íŠ¸ ë™ê¸°í™”
                const statsElement = document.getElementById('downloadStats');
                if (statsElement) {
                    statsElement.innerHTML = statsHtml;
                }
            } catch (err) {
                console.error('í†µê³„ í‘œì‹œ ì˜¤ë¥˜:', err);
            }
        }

        // Google Drive íŒŒì¼ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸° ë¡œë“œ
        async function previewFileFromDrive(fileId, fileName) {
            try {
                // Drive APIë¥¼ ì´ìš©í•˜ì—¬ íŒŒì¼ ë‚´ìš© ê°€ì ¸ì˜¤ê¸° (CORS ë¬¸ì œ íšŒí”¼)
                await initGapiClient();
                const response = await gapi.client.drive.files.get({
                    fileId: fileId,
                    alt: 'media'
                });
                let text = response.body;
                if (typeof text !== 'string') {
                    text = JSON.stringify(text);
                }
                // ê¸¸ì´ ì œí•œ
                if (text.length > 500) {
                    text = text.substring(0, 500) + '\n\n[â‹® ë‹¨ì¶•ëœ ë‚´ìš© â‹®]';
                }
                document.getElementById('previewHeader').textContent = `íŒŒì¼: ${fileName}`;
                document.getElementById('previewContent').textContent = text;
                document.getElementById('filePreview').classList.add('show');
            } catch (err) {
                console.error('íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° ë¡œë“œ ì˜¤ë¥˜:', err);
            }
        }

        // ë¯¸ë¦¬ë³´ê¸° ì»¨ë¥¸ë‹¤ëŠ±
        function hidePreview() {
            document.getElementById('filePreview').classList.remove('show');
        }

        // ì„œë¹„ìŠ¤ ë©”ë‰´ì—ì„œ íŒŒì¼ì„ ê°€ì ¸ì™€ì„œ ì„œë¸Œë©”ë‰´ì— ì¶”ê°€
        async function populateServiceMenu(submenuElement, folderName) {
            if (driveMenuLoaded) return;
            driveMenuLoaded = true;

            if (!SERVICE_FOLDER_ID || SERVICE_FOLDER_ID === 'YOUR_FOLDER_ID_HERE') {
                const msgItem = document.createElement('div');
                msgItem.className = 'submenu-item error';
                msgItem.textContent = 'ìë£Œì‹¤(êµ¬ê¸€ë“œë¼ì´ë¸Œ) í´ë” IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. index.htmlì—ì„œ SERVICE_FOLDER_ID ê°’ì„ ì…ë ¥í•˜ì„¸ìš”.';
                submenuElement.appendChild(msgItem);
                return;
            }

            try {
                const files = await fetchDriveFilesFromFolder(SERVICE_FOLDER_ID);
                if (files.length === 0) {
                    const emptyItem = document.createElement('div');
                    emptyItem.className = 'submenu-item';
                    emptyItem.textContent = '(Google Driveì— íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤)';
                    submenuElement.appendChild(emptyItem);
                    return;
                }

                files.forEach(file => {
                    const menuItem = document.createElement('div');
                    menuItem.className = 'submenu-item';
                    menuItem.textContent = file.name;
                    
                    // ë§ˆìš°ìŠ¤ í˜¸ë²„ ë¯¸ë¦¬ë³´ê¸°
                    menuItem.onmouseenter = () => {
                        previewFileFromDrive(file.id, file.name);
                    };
                    
                    menuItem.onmouseleave = () => {
                        hidePreview();
                    };
                    
                    // í´ë¦­ ë‹¤ìš´ë¡œë“œ
                    menuItem.onclick = (e) => {
                        e.stopPropagation();
                        // í™œì„±í™” ìŠ¤íƒ€ì¼
                        document.querySelectorAll('.submenu-item').forEach(i => i.classList.remove('active'));
                        menuItem.classList.add('active');
                        
                        // ë‹¤ìš´ë¡œë“œ ë‹¨ê³„ì— ê¸°ë¡
                        recordDownload(file.name, file.id);
                        
                        // ë‹¤ìš´ë¡œë“œ ë§í¬ ì—´ê¸°
                        const downloadUrl = `https://drive.google.com/uc?export=download&id=${file.id}`;
                        window.open(downloadUrl, '_blank');
                    };
                    submenuElement.appendChild(menuItem);
                });
            } catch (err) {
                console.error('Drive íŒŒì¼ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', err);
                const errorItem = document.createElement('div');
                errorItem.className = 'submenu-item error';
                errorItem.textContent = 'Google Drive ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
                submenuElement.appendChild(errorItem);
            }
        }

        // Obsidian ë³¼íŠ¸ ë©”ë‰´ì—ì„œ íŒŒì¼ì„ ê°€ì ¸ì™€ì„œ ì„œë¸Œë©”ë‰´ì— ì¶”ê°€
async function populateObsidianMenu(submenuElement, folderName) {
    if (obsidianMenuLoaded) return;
    obsidianMenuLoaded = true;

    try {
        const response = await fetch('http://localhost:3000/api/obsidian-files');
        if (!response.ok) throw new Error('íŒŒì¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        const files = await response.json();

        if (files.length === 0) {
            const emptyItem = document.createElement('div');
            emptyItem.className = 'submenu-item';
            emptyItem.textContent = '(íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤)';
            submenuElement.appendChild(emptyItem);
            return;
        }

        // í´ë”ë³„ë¡œ ê·¸ë£¹í•‘
        const grouped = {};
        files.forEach(file => {
            const folder = file.folder || 'ë£¨íŠ¸';
            if (!grouped[folder]) grouped[folder] = [];
            grouped[folder].push(file);
        });

        // í´ë”ë³„ë¡œ ë Œë”ë§
        Object.keys(grouped).sort().forEach(folder => {
            // í´ë” í—¤ë”
            const folderDiv = document.createElement('div');
            folderDiv.style.cssText = 'font-size:12px; margin-top:10px; padding:4px 8px; background:#3d5166; color:#a8c0d6; border-radius:3px; cursor:pointer;';
            folderDiv.textContent = 'ğŸ“ ' + folder;

            const fileList = document.createElement('div');
            fileList.style.display = 'none'; // ê¸°ë³¸ ì ‘í˜

            folderDiv.onclick = (e) => {
                e.stopPropagation();
                fileList.style.display = fileList.style.display === 'none' ? 'block' : 'none';
            };

            submenuElement.appendChild(folderDiv);
            submenuElement.appendChild(fileList);

            // íŒŒì¼ ëª©ë¡
            grouped[folder].forEach(file => {
                const menuItem = document.createElement('div');
                menuItem.className = 'submenu-item';
                menuItem.textContent = 'ğŸ“„ ' + file.name;
                menuItem.style.paddingLeft = '20px';

                menuItem.onclick = async (e) => {
                    e.stopPropagation();
                    document.querySelectorAll('.submenu-item').forEach(i => i.classList.remove('active'));
                    menuItem.classList.add('active');

                    try {
                        const fileRes = await fetch(`http://localhost:3000/api/obsidian-file/${encodeURIComponent(file.path)}`);
                        if (!fileRes.ok) throw new Error('íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                        const data = await fileRes.text();

                        const htmlContent = markdownToHtml(data);
                        const contentDiv = document.getElementById('content');
                        contentDiv.innerHTML = `
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                                <div>
                                    <div class="breadcrumb">ìë£Œì‹¤(ì˜µì‹œë””ì•ˆ) > ${folder} > ${file.name}</div>
                                    <h2>${file.name}</h2>
                                </div>
                                <button onclick="downloadObsidianFile('${file.path}', '${file.name}')"
                                    style="padding:8px 16px; background:#3498db; color:white; border:none; border-radius:4px; cursor:pointer;">
                                    â¬‡ï¸ ë‹¤ìš´ë¡œë“œ
                                </button>
                            </div>
                            ${htmlContent}
                        `;
                        contentDiv.className = 'content markdown-body';
                    } catch (err) {
                        console.error('íŒŒì¼ ë¡œë“œ ì˜¤ë¥˜:', err);
                        document.getElementById('content').innerHTML = `<p style="color:red;">íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${err.message}</p>`;
                    }
                };
                fileList.appendChild(menuItem);
            });
        });

    } catch (err) {
        console.error('Obsidian íŒŒì¼ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', err);
        const errorItem = document.createElement('div');
        errorItem.className = 'submenu-item error';
        errorItem.textContent = 'âš ï¸ ë¡œì»¬ ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤. server.jsë¥¼ ì‹œì‘í•˜ì„¸ìš”.';
        submenuElement.appendChild(errorItem);
    }
}

        // Obsidian íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        async function downloadObsidianFile(filePath, fileName) {
            try {
                const response = await fetch(`http://localhost:3000/api/download/${encodeURIComponent(filePath)}`);
                if (!response.ok) throw new Error('ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨');
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                // ë‹¤ìš´ë¡œë“œ í†µê³„ ê¸°ë¡
                recordDownload(fileName, filePath);
            } catch (err) {
                console.error('ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', err);
                alert('ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + err.message);
            }
        }


        // ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜ (ê°„ë‹¨í•œ ë²„ì „)
        function markdownToHtml(markdown) {
            let html = markdown;
            
            // ì œëª© ì²˜ë¦¬
            html = html.replace(/^### (.*?)$/gm, '<h3>$1</h3>');
            html = html.replace(/^## (.*?)$/gm, '<h2>$1</h2>');
            html = html.replace(/^# (.*?)$/gm, '<h1>$1</h1>');
            
            // êµµì€ ê¸€ì”¨
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/__(.*?)__/g, '<strong>$1</strong>');
            
            // ê¸°ìš¸ì„
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            html = html.replace(/_(.*?)_/g, '<em>$1</em>');
            
            // ë§í¬
            html = html.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank">$1</a>');
            
            // ì¤„ ë°”ê¿ˆ
            html = html.replace(/\n\n/g, '</p><p>');
            html = '<p>' + html + '</p>';
            
            // ì½”ë“œ ë¸”ë¡
            html = html.replace(/```(.*?)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
            
            // ì¸ë¼ì¸ ì½”ë“œ
            html = html.replace(/`(.*?)`/g, '<code>$1</code>');
            
            // ë¦¬ìŠ¤íŠ¸
            html = html.replace(/^- (.*?)$/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
            html = html.replace(/^(\d+)\. (.*?)$/gm, '<li>$2</li>');
            
            // í‘œ ì²˜ë¦¬
            html = html.replace(/\|(.+)\|/g, (match) => {
                const cells = match.split('|').filter(cell => cell.trim());
                return '<tr>' + cells.map(cell => `<td>${cell.trim()}</td>`).join('') + '</tr>';
            });
            html = html.replace(/(<tr>.*?<\/tr>)/s, '<table>$1</table>');
            
            return html;
        }

        // Google Drive ë§ˆí¬ë‹¤ìš´ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadFileFromGoogleDrive(fileId, itemName, folder) {
            content.innerHTML = `
                <div class="breadcrumb">${folder} > ${itemName}</div>
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Google Driveì—ì„œ íŒŒì¼ì„ ë¡œë”© ì¤‘...</p>
                </div>
            `;

            try {
                // Google Drive íŒŒì¼ì„ ê³µê°œ ê³µìœ  ë§í¬ë¡œ ë‹¤ìš´ë¡œë“œ
                // ì˜µì…˜ 1: ê³µê°œ ë‹¤ìš´ë¡œë“œ URL
                const driveUrl = `https://drive.google.com/uc?export=download&id=${fileId}`;
                
                console.log('Google Drive URL:', driveUrl);
                
                const response = await fetch(driveUrl, {
                    method: 'GET'
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    // ì˜µì…˜ 2: ê³µê°œ ê³µìœ  ë§í¬ ì‚¬ìš© (ì‚¬ìš©ìê°€ ë§í¬ë¥¼ ì œê³µí•´ì•¼ í•¨)
                    throw new Error(`HTTP ì˜¤ë¥˜! ìƒíƒœ: ${response.status} - íŒŒì¼ì´ ê³µê°œ ì„¤ì •ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.`);
                }
                
                const markdown = await response.text();
                
                if (markdown.length === 0) {
                    throw new Error('íŒŒì¼ ë‚´ìš©ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
                }
                
                const htmlContent = markdownToHtml(markdown);
                
                content.innerHTML = `
                    <div class="breadcrumb">${folder} > ${itemName}</div>
                    <div class="file-content">
                        ${htmlContent}
                    </div>
                `;

                currentFileId = fileId;
                
                // í™œì„±í™”ëœ ë©”ë‰´ í‘œì‹œ
                document.querySelectorAll('.submenu-item').forEach(item => {
                    item.classList.remove('active');
                });
                if (event && event.target) {
                    event.target.classList.add('active');
                }
            } catch (error) {
                console.error('Google Drive ë¡œë“œ ì˜¤ë¥˜:', error);
                content.innerHTML = `
                    <div class="breadcrumb">${folder} > ${itemName}</div>
                    <div class="error">
                        <strong>âŒ Google Drive íŒŒì¼ ë¡œë“œ ì˜¤ë¥˜</strong><br>
                        ${error.message}<br><br>
                        <small><strong>í•´ê²° ë°©ë²•:</strong><br>
                        1. Google Drive íŒŒì¼ì„ ìš°í´ë¦­<br>
                        2. "ê³µìœ " í´ë¦­<br>
                        3. "ë§í¬ê°€ ìˆëŠ” ëª¨ë“  ì‚¬ìš©ì" ë˜ëŠ” "ê³µê°œ"ë¡œ ì„¤ì •<br>
                        4. <strong>ì €ë„ ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŒ</strong> ê¶Œí•œ í™•ì¸<br>
                        ë˜ëŠ” <strong>ë§ˆí¬ë‹¤ìš´ íŒŒì¼ì„ ë¡œì»¬ì— ì €ì¥</strong>í•´ì„œ ì‚¬ìš©í•˜ì„¸ìš”.
                        </small>
                    </div>
                `;
            }
        }

        // íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° (í™•ì¥ëœ ë²„ì „ - ë¡œì»¬ ë˜ëŠ” Google Drive)
        async function loadFile(filePath, itemName, folder) {
            content.innerHTML = `
                <div class="breadcrumb">${folder} > ${itemName}</div>
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>ë¡œë”© ì¤‘...</p>
                </div>
            `;

            try {
                // ë‹¤ìš´ë¡œë“œ í†µê³„ í˜ì´ì§€
                if (filePath === 'STATS') {
                    try {
                        const stats = JSON.parse(localStorage.getItem('downloadStats')) || [];
                        stats.sort((a, b) => new Date(b.lastDownload) - new Date(a.lastDownload));
                        
                        let statsHtml = `<div class="breadcrumb">${folder} > ${itemName}</div>`;
                        statsHtml += '<div style="padding: 20px;">';
                        statsHtml += '<h2>ğŸ“Š íŒŒì¼ ë‹¤ìš´ë¡œë“œ í†µê³„</h2>';
                        
                        if (stats.length === 0) {
                            statsHtml += '<p style="opacity: 0.6; margin-top: 20px;">ì•„ì§ ë‹¤ìš´ë¡œë“œ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                        } else {
                            statsHtml += '<table style="width: 100%; border-collapse: collapse; margin-top: 15px;">';
                            statsHtml += '<tr style="background: #f0f0f0; border-bottom: 2px solid #ccc;">';
                            statsHtml += '<th style="padding: 10px; text-align: left;">íŒŒì¼ëª…</th>';
                            statsHtml += '<th style="padding: 10px; text-align: center;">ë‹¤ìš´ë¡œë“œ íšŸìˆ˜</th>';
                            statsHtml += '<th style="padding: 10px; text-align: left;">ì´ˆê¸° ë‹¤ìš´ë¡œë“œ</th>';
                            statsHtml += '<th style="padding: 10px; text-align: left;">ë§ˆì§€ë§‰ ë‹¤ìš´ë¡œë“œ</th>';
                            statsHtml += '</tr>';
                            
                            stats.forEach(stat => {
                                statsHtml += '<tr style="border-bottom: 1px solid #eee;">';
                                statsHtml += `<td style="padding: 10px;">${stat.fileName}</td>`;
                                statsHtml += `<td style="padding: 10px; text-align: center; color: #3498db; font-weight: bold;">${stat.count}íšŒ</td>`;
                                statsHtml += `<td style="padding: 10px; font-size: 12px;">${stat.firstDownload}</td>`;
                                statsHtml += `<td style="padding: 10px; font-size: 12px;">${stat.lastDownload}</td>`;
                                statsHtml += '</tr>';
                            });
                            statsHtml += '</table>';
                            statsHtml += `<p style="margin-top: 20px; color: #999; font-size: 12px;">ì´ ${stats.length}ê°œ íŒŒì¼, ${stats.reduce((sum, s) => sum + s.count, 0)}íšŒ ë‹¤ìš´ë¡œë“œ</p>`;
                        }
                        statsHtml += '</div>';
                        content.innerHTML = statsHtml;
                    } catch (err) {
                        content.innerHTML = `<div class="error">í†µê³„ ë¡œë“œ ì˜¤ë¥˜: ${err.message}</div>`;
                    }
                    return;
                }
                
                // Google Drive íŒŒì¼ ID íŒë³„ (ê¸¸ê³  ì•ŒíŒŒë²³+ìˆ«ì ì¡°í•©)
                if (/^[a-zA-Z0-9_-]{25,}$/.test(filePath)) {
                    // Google Drive íŒŒì¼ ID
                    await loadFileFromGoogleDrive(filePath, itemName, folder);
                } else {
                    // ë¡œì»¬ ë§ˆí¬ë‹¤ìš´ íŒŒì¼
                    const response = await fetch(filePath);
                    
                    if (!response.ok) {
                        throw new Error(`íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${filePath}`);
                    }
                    
                    const markdown = await response.text();
                    const htmlContent = markdownToHtml(markdown);
                    
                    content.innerHTML = `
                        <div class="breadcrumb">${folder} > ${itemName}</div>
                        <div class="file-content">
                            ${htmlContent}
                        </div>
                    `;

                    currentFileId = filePath;
                    
                    // í™œì„±í™”ëœ ë©”ë‰´ í‘œì‹œ
                    document.querySelectorAll('.submenu-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    if (event && event.target) {
                        event.target.classList.add('active');
                    }
                }
            } catch (error) {
                content.innerHTML = `
                    <div class="breadcrumb">${folder} > ${itemName}</div>
                    <div class="error">
                        <strong>âŒ ì˜¤ë¥˜ ë°œìƒ</strong><br>
                        íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${error.message}<br><br>
                        <small>í•´ê²° ë°©ë²•: ë§ˆí¬ë‹¤ìš´ íŒŒì¼ì´ ê°™ì€ í´ë”ì— ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.</small>
                    </div>
                `;
            }
        }

        // ë©”ë‰´ ìƒì„±
        function renderMenu() {
            for (const [folder, items] of Object.entries(menuData)) {
                const folderDiv = document.createElement('div');
                
                const folderItem = document.createElement('div');
                folderItem.className = 'menu-item';
                folderItem.innerHTML = `${folder} <span class="toggle-icon">â–¼</span>`;
                folderItem.onclick = async (e) => {
                    e.stopPropagation();
                    const submenu = folderDiv.querySelector('.submenu');
                    submenu.classList.toggle('active');
                    // ìë£Œì‹¤(êµ¬ê¸€ë“œë¼ì´ë¸Œ) í´ë”ëŠ” í´ë¦­ ì‹œ ë“œë¼ì´ë¸Œ ëª©ë¡ì„ ë¡œë“œ
                    if (folder === 'ìë£Œì‹¤(êµ¬ê¸€ë“œë¼ì´ë¸Œ)' && submenu.childElementCount === 0) {
                        await populateServiceMenu(submenu, folder);
                    }
                    // ìë£Œì‹¤(ì˜µì‹œë””ì•ˆ) í´ë”ëŠ” í´ë¦­ ì‹œ ë¡œì»¬ ì„œë²„ì—ì„œ íŒŒì¼ ëª©ë¡ ë¡œë“œ
                    if (folder === 'ìë£Œì‹¤(ì˜µì‹œë””ì•ˆ)' && submenu.childElementCount === 0) {
                        await populateObsidianMenu(submenu, folder);
                    }
                };
                
                const submenu = document.createElement('div');
                submenu.className = 'submenu';
                
                if (items) {
                    for (const [itemName, filePath] of Object.entries(items)) {
                        const submenuItem = document.createElement('div');
                        submenuItem.className = 'submenu-item';
                        submenuItem.textContent = itemName;
                        submenuItem.onclick = (e) => loadFile(filePath, itemName, folder);
                        submenu.appendChild(submenuItem);
                    }
                }
                
                folderDiv.appendChild(folderItem);
                folderDiv.appendChild(submenu);
                sidebar.appendChild(folderDiv);
            }
        }

        // ì´ˆê¸°í™”
        renderMenu();
    </script>
</body>
</html>
